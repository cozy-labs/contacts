// Generated by CoffeeScript 1.8.0
var Client, Config, Contact, async, getImports, i18n;

Contact = require('../models/contact');

Config = require('../models/config');

i18n = require('cozy-i18n-helper');

async = require('async');

Client = require('request-json').JsonClient;

getImports = function(callback) {
  return async.parallel([
    function(cb) {
      return Contact.request('all', cb);
    }, function(cb) {
      return Config.getInstance(cb);
    }, function(cb) {
      return i18n.getLocale(null, cb);
    }, function(cb) {
      var dataSystem;
      dataSystem = new Client("http://localhost:9101/");
      return dataSystem.get('tags', function(err, response, body) {
        return cb(err, body);
      });
    }
  ], function(err, results) {
    var config, contacts, locale, tags;
    contacts = results[0], config = results[1], locale = results[2], tags = results[3];
    return callback(null, "window.config = " + (JSON.stringify(config)) + ";\nwindow.locale = \"" + locale + "\";\nwindow.initcontacts = " + (JSON.stringify(contacts)) + ";\nwindow.tags = " + (JSON.stringify(tags)) + ";");
  });
};

module.exports = {
  index: function(req, res) {
    return getImports(function(err, imports) {
      if (err) {
        return res.error(500, 'An error occured', err);
      }
      return res.render('index.jade', {
        imports: imports
      });
    });
  },
  widget: function(req, res) {
    return getImports(function(err, imports) {
      if (err) {
        return res.error(500, 'An error occured', err);
      }
      return res.render('widget.jade', {
        imports: imports
      });
    });
  },
  setConfig: function(req, res) {
    return Config.set(req.body, function(err, config) {
      if (err) {
        return res.error(500, 'An error occured', err);
      }
      return res.send(config);
    });
  }
};
